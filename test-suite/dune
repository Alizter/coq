(rule
 (alias test-gen)
 (targets test_suite_rules.sexp)
 (deps
  (source_tree bugs)
  ; (source_tree complexity)
  ; (source_tree coq-makefile)
  ; (source_tree coqchk)
  ; (source_tree coqdoc)
  ; (source_tree coqwc)
  (source_tree failure)
  ; (source_tree ide)
  ; (source_tree interactive)
  (source_tree ltac2)
  (source_tree micromega)
  (source_tree misc)
  (source_tree modules)
  (source_tree output)
  (source_tree output-coqchk)
  ; (source_tree output-coqtop)
  (source_tree output-failure)
  ; (source_tree output-modulo-time)
  (source_tree prerequisite)
  (source_tree primitive)
  (source_tree ssr)
  (source_tree stm)
  (source_tree success)
  (source_tree vio)


  ; We rely on coqdeplib
  (source_tree ../tools/coqdep)
  (source_tree ../theories)
  (source_tree ../user-contrib)

  %{bin:coqtacticworker.opt}
  %{bin:coqqueryworker.opt}
  %{bin:coqproofworker.opt}

  .csdp.cache
  %{bin:csdpcert})
 (mode promote)
 (action (run ./tools/gen_rules/gen_rules.exe)))

(include test_suite_rules.sexp)

; the expected output for the MExtraction test is plugins/micromega/micromega.ml
; except with additional newline
(subdir output
 (rule
  (targets MExtraction.out)
  (action
   (with-stdout-to %{targets}
    (progn
     (cat ../../plugins/micromega/micromega.ml)
     (echo "\n"))))))

(rule
 (targets .csdp.cache)
 (deps .csdp.cache.test-suite)
  (action
  (progn
  ; Cache set this to read-only
  (copy %{deps} %{targets})
  (bash "chmod u+w %{targets}"))))
